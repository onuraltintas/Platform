<div class="page page-center">
  <div class="container container-tight py-4">
    <div class="text-center mb-4">
      <a href="." class="navbar-brand navbar-brand-autodark">
        <img src="logo.png" width="110" height="32" alt="OnAl Yazılım" class="navbar-brand-image">
      </a>
    </div>

    @if (!passwordReset()) {
      @if (!tokenValid()) {
        <!-- Invalid Token Message -->
        <div class="card card-md">
          <div class="card-body text-center">
            <div class="text-warning mb-3">
              <lucide-angular [img]="Shield" class="icon icon-lg"></lucide-angular>
            </div>
            <h2 class="h2 text-warning mb-4">Geçersiz Token</h2>
            <p class="text-muted mb-4">
              Şifre sıfırlama bağlantısı geçersiz veya süresi dolmuş.
              Lütfen yeni bir bağlantı talep edin.
            </p>
            <a routerLink="/auth/forgot-password" class="btn btn-primary w-100">
              Yeni Bağlantı Talep Et
            </a>
          </div>
        </div>
      } @else {
        <!-- Reset Password Form -->
        <div class="card card-md">
          <div class="card-body">
            <h2 class="h2 text-center mb-4">Şifre Sıfırlama</h2>
            <p class="text-muted text-center mb-4">Yeni şifrenizi belirleyin</p>

            <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" novalidate>
              <!-- New Password Field -->
              <div class="mb-3">
                <label class="form-label">Yeni Şifre</label>
                <div class="input-group input-group-flat">
                  <span class="input-group-text">
                    <lucide-angular [img]="Lock" class="icon"></lucide-angular>
                  </span>
                  <input
                    [type]="showPassword() ? 'text' : 'password'"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('newPassword')"
                    formControlName="newPassword"
                    placeholder="Yeni şifrenizi girin"
                    autocomplete="new-password">
                  <span class="input-group-text">
                    <a href="#" class="link-secondary" (click)="togglePasswordVisibility(); $event.preventDefault()">
                      <lucide-angular
                        [img]="showPassword() ? EyeOff : Eye"
                        class="icon">
                      </lucide-angular>
                    </a>
                  </span>
                </div>
                @if (isFieldInvalid('newPassword')) {
                  <div class="invalid-feedback">
                    @if (resetPasswordForm.get('newPassword')?.errors?.['required']) {
                      Şifre gereklidir
                    }
                    @if (resetPasswordForm.get('newPassword')?.errors?.['minlength']) {
                      Şifre en az 8 karakter olmalıdır
                    }
                  </div>
                }
              </div>

              <!-- Confirm Password Field -->
              <div class="mb-3">
                <label class="form-label">Şifre Onayı</label>
                <div class="input-group input-group-flat">
                  <span class="input-group-text">
                    <lucide-angular [img]="Lock" class="icon"></lucide-angular>
                  </span>
                  <input
                    [type]="showConfirmPassword() ? 'text' : 'password'"
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('confirmPassword')"
                    formControlName="confirmPassword"
                    placeholder="Şifrenizi tekrar girin"
                    autocomplete="new-password">
                  <span class="input-group-text">
                    <a href="#" class="link-secondary" (click)="toggleConfirmPasswordVisibility(); $event.preventDefault()">
                      <lucide-angular
                        [img]="showConfirmPassword() ? EyeOff : Eye"
                        class="icon">
                      </lucide-angular>
                    </a>
                  </span>
                </div>
                @if (isFieldInvalid('confirmPassword')) {
                  <div class="invalid-feedback">
                    @if (resetPasswordForm.get('confirmPassword')?.errors?.['required']) {
                      Şifre onayı gereklidir
                    }
                    @if (resetPasswordForm.get('confirmPassword')?.errors?.['mismatch']) {
                      Şifreler eşleşmiyor
                    }
                  </div>
                }
              </div>

              <!-- Password Strength Indicator -->
              @if (passwordStrength() && passwordStrength().strength > 0) {
                <div class="mb-3">
                  <div class="form-label">Şifre Gücü</div>
                  <div class="progress progress-sm">
                    <div
                      class="progress-bar"
                      [class]="'bg-' + passwordStrength().color"
                      [style.width.%]="passwordStrength().strength * 25"
                      role="progressbar">
                    </div>
                  </div>
                  <small class="form-hint" [class]="'text-' + passwordStrength().color">
                    {{ passwordStrength().label }}
                  </small>
                </div>
              }

              <!-- Submit Button -->
              <div class="form-footer">
                <button
                  type="submit"
                  class="btn btn-primary w-100"
                  [disabled]="resetPasswordForm.invalid || isLoading()">
                  @if (isLoading()) {
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Şifre Güncelleniyor...
                  } @else {
                    <lucide-angular [img]="CheckCircle" class="icon me-1"></lucide-angular>
                    Şifremi Güncelle
                  }
                </button>
              </div>
            </form>
          </div>
        </div>
      }
    } @else {
      <!-- Success Message -->
      <div class="card card-md">
        <div class="card-body text-center">
          <div class="text-success mb-3">
            <lucide-angular [img]="CheckCircle" class="icon icon-lg"></lucide-angular>
          </div>
          <h2 class="h2 text-success mb-4">Şifre Güncellendi!</h2>
          <p class="text-muted mb-4">
            Şifreniz başarıyla güncellendi. Artık yeni şifrenizle giriş yapabilirsiniz.
          </p>
          <a routerLink="/auth/login" class="btn btn-primary w-100">
            Giriş Sayfasına Git
          </a>
        </div>
      </div>
    }

    <!-- Back to Login -->
    <div class="text-center mt-3">
      <a routerLink="/auth/login" class="text-decoration-none">
        Giriş sayfasına dön
      </a>
    </div>
  </div>
</div>